#!/bin/bash

POLL_INTERVAL=5
POLL_TIMEOUT=600

# Poll shutdown-deferrer service in order to wait for proper node draining
# before VM shutdown.
DEFER="true"
while [ "$DEFER" = "true" -a $POLL_TIMEOUT -gt 0 ]
do
    sleep $POLL_INTERVAL
    DEFER=$(/usr/bin/curl -qsS http://127.0.0.1:60080/v1/defer/)
    echo "GET /v1/defer: $DEFER"
    POLL_TIMEOUT=$(/bin/expr $POLL_TIMEOUT - $POLL_INTERVAL)
done

# Send graceful shutdown command to qemu monitor.
echo system_powerdown | socat - UNIX-CONNECT:/qemu-monitor

# Wait while VM shutting down (socket exists) and then return.
while [ -S /qemu-monitor ]
do
  sleep 0.1
done
